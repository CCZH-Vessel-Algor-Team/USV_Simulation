# USV_Simulation é¡¹ç›®ä»£ç èµ„äº§æ¦‚è¿°æ–‡æ¡£

## 1. æ–‡ä»¶ç»“æ„æ‹“æ‰‘ (File System Topology)

```
USV_Simulation/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ usv_sim_full/                    # ä¸»æ§åŠŸèƒ½åŒ…
â”‚   â”‚   â”œâ”€â”€ launch/
â”‚   â”‚   â”‚   â”œâ”€â”€ main.launch.py           # ğŸ¯ ä¸»å¯åŠ¨æ–‡ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ components/
â”‚   â”‚   â”‚       â”œâ”€â”€ infra_sim.launch.py    # åŸºç¡€è®¾æ–½ä»¿çœŸå¯åŠ¨
â”‚   â”‚   â”‚       â”œâ”€â”€ robot_bringup.launch.py # æœºå™¨äººç³»ç»Ÿå¯åŠ¨
â”‚   â”‚   â”‚       â””â”€â”€ visualization.launch.py # å¯è§†åŒ–å¯åŠ¨
â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â”œâ”€â”€ full_config.yaml         # ğŸ“„ ä¸»é…ç½®æ–‡ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ global_bridge.yaml       # å…¨å±€æ¡¥æ¥é…ç½®
â”‚   â”‚   â”œâ”€â”€ scripts/
â”‚   â”‚   â”‚   â”œâ”€â”€ session_manager.py       # ğŸ§  ä¼šè¯ç®¡ç†å™¨æ ¸å¿ƒ
â”‚   â”‚   â”‚   â”œâ”€â”€ dual_thruster_teleop_incre.py # ğŸ® åŒæ¨è¿›å™¨æ§åˆ¶å™¨
â”‚   â”‚   â”‚   â””â”€â”€ load_robot_description.py # æœºå™¨äººæè¿°åŠ è½½å™¨
â”‚   â”‚   â”œâ”€â”€ templates/
â”‚   â”‚   â”‚   â”œâ”€â”€ wamv_no_battery.urdf.xacro # ğŸ¤– WAM-Væ— ç”µæ± æ¨¡æ¿
â”‚   â”‚   â”‚   â””â”€â”€ sensor_macros.xacro      # ä¼ æ„Ÿå™¨å®å®šä¹‰æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ package.xml                  # åŒ…ä¾èµ–å®šä¹‰
â”‚   â”‚   â””â”€â”€ setup.py                     # PythonåŒ…é…ç½®
â”‚   â”‚
â”‚   â””â”€â”€ vrx/                             # VRXç«èµ›æ¡†æ¶
â”‚       â”œâ”€â”€ vrx_gz/                      # Gazeboæ’ä»¶å’Œä¸–ç•Œ
â”‚       â”‚   â”œâ”€â”€ worlds/                  # ğŸŒ SDFä¸–ç•Œæ–‡ä»¶
â”‚       â”‚   â”‚   â”œâ”€â”€ sydney_regatta.sdf     # æ‚‰å°¼å¸†èˆ¹èµ›åœº
â”‚       â”‚   â”‚   â”œâ”€â”€ wayfinding_task.sdf    # å¯¼èˆªä»»åŠ¡åœºæ™¯
â”‚       â”‚   â”‚   â””â”€â”€ perception_task.sdf    # æ„ŸçŸ¥ä»»åŠ¡åœºæ™¯
â”‚       â”‚   â””â”€â”€ package.xml
â”‚       â”‚
â”‚       â”œâ”€â”€ vrx_urdf/                    # URDFç›¸å…³èµ„æº
â”‚       â”‚   â””â”€â”€ wamv_description/        # WAM-Væè¿°åŒ…
â”‚       â”‚       â””â”€â”€ models/              # ğŸ¨ 3Dæ¨¡å‹ç½‘æ ¼æ–‡ä»¶
â”‚       â”‚           â”œâ”€â”€ WAM-V-Base/      # èˆ¹ä½“åŸºç¡€æ¨¡å‹
â”‚       â”‚           â”œâ”€â”€ engine/          # å‘åŠ¨æœºæ¨¡å‹
â”‚       â”‚           â””â”€â”€ propeller/       # èºæ—‹æ¡¨æ¨¡å‹
â”‚       â”‚
â”‚       â””â”€â”€ vrx_ros/                     # ROSæ¥å£åŒ…
â”‚           â””â”€â”€ package.xml
â”‚
â”œâ”€â”€ dual_thruster_teleop_incre.py        # ğŸ® ç‹¬ç«‹æ§åˆ¶å™¨è„šæœ¬
â”œâ”€â”€ README.md                           # é¡¹ç›®ä¸»æ–‡æ¡£
â””â”€â”€ QUICK_START.md                      # å¿«é€Ÿå…¥é—¨æŒ‡å—
```

## 2. å…³é”®æ¨¡å—è§£æ (Key Modules Analysis)

### URDF ç”Ÿæˆé€»è¾‘

**æ ¸å¿ƒæµç¨‹**ï¼š`session_manager.py` â†’ `compile_xacro_to_urdf()` å‡½æ•°

```python
def compile_xacro_to_urdf(root_xacro_path, config_data, session_dir):
    # 1. ç¡®å®šXacroæ¨¡æ¿æ¥æº
    xacro_template = robot_config.get('xacro_template', 'wamv_gazebo.urdf.xacro')
    
    # 2. æ„å»ºxacroå‘½ä»¤è¡Œå‚æ•°
    cmd = ['ros2', 'run', 'xacro', 'xacro', xacro_input, 'name:=wamv']
    
    # 3. æ³¨å…¥ç‰©ç†å‚æ•°è¦†ç›–
    overrides = robot_config.get('overrides', {})
    for key, value in overrides.items():
        if key == 'inertia':
            cmd.extend([f'ixx:={value[0]}', f'iyy:={value[1]}', f'izz:={value[2]}'])
        else:
            cmd.append(f'{key}:={value}')
    
    # 4. æ·»åŠ æ¨è¿›å™¨é…ç½®
    thruster_config = robot_config.get('thruster_config', 'H')
    cmd.append(f'thruster_config:={thruster_config}')
    
    # 5. æ‰§è¡Œç¼–è¯‘å¹¶åå¤„ç†
    subprocess.run(cmd)
    post_process_urdf_for_gazebo(urdf_path)  # åè®®è½¬æ¢
```

**å‚æ•°æ³¨å…¥ç‚¹**ï¼š
- `overrides.mass` â†’ è´¨é‡è¦†ç›–
- `overrides.inertia` â†’ æƒ¯æ€§çŸ©é˜µè¦†ç›–  
- `overrides.visual_mesh` â†’ å¤–è§‚ç½‘æ ¼è·¯å¾„
- `thruster_config` â†’ æ¨è¿›å™¨å¸ƒå±€é…ç½®

### Launch å¯åŠ¨æ ‘

**å±‚çº§è°ƒç”¨å…³ç³»**ï¼š
```
main.launch.py (å…¥å£)
â”œâ”€â”€ infra_sim.launch.py (åŸºç¡€è®¾æ–½)
â”‚   â”œâ”€â”€ è®¾ç½®ç¯å¢ƒå˜é‡: GZ_SIM_RESOURCE_PATH
â”‚   â”œâ”€â”€ å¯åŠ¨Gazeboä»¿çœŸç¯å¢ƒ
â”‚   â””â”€â”€ å¯åŠ¨å…¨å±€æ¡¥æ¥èŠ‚ç‚¹
â”œâ”€â”€ robot_bringup.launch.py (æœºå™¨äººç³»ç»Ÿ)
â”‚   â”œâ”€â”€ robot_state_publisher (çŠ¶æ€å‘å¸ƒ)
â”‚   â”œâ”€â”€ ros_gz_sim create (å®ä½“åˆ›å»º)
â”‚   â”œâ”€â”€ sensor_bridge (ä¼ æ„Ÿå™¨æ¡¥æ¥)
â”‚   â””â”€â”€ obstacle_spawner (éšœç¢ç‰©ç”Ÿæˆ)
â””â”€â”€ visualization.launch.py (å¯è§†åŒ–)
    â””â”€â”€ rviz2 (å¯è§†åŒ–ç•Œé¢)
```

**å‚æ•°é€ä¼ æœºåˆ¶**ï¼š
```python
# main.launch.py ä¸­çš„å‚æ•°ä¼ é€’
launch_arguments={
    'robot_name': robot_name,
    'urdf_path': urdf_path,           # ä¼šè¯ç®¡ç†å™¨ç”Ÿæˆ
    'bridge_config_path': bridge_yaml_path,  # åŠ¨æ€ç”Ÿæˆ
    'obstacle_layout_path': obstacle_layout_path
}.items()
```

### VRX èµ„äº§è·¯å¾„

**æ¨¡å‹æ–‡ä»¶å­˜å‚¨**ï¼š
- `src/vrx/vrx_urdf/wamv_description/models/` - 3Dç½‘æ ¼æ–‡ä»¶(.dae)
- `src/vrx/vrx_gz/worlds/` - SDFä¸–ç•Œæ–‡ä»¶

**ç¯å¢ƒå˜é‡å¼•ç”¨**ï¼š
```python
# infra_sim.launch.py ä¸­çš„è·¯å¾„è®¾ç½®
wamv_path = get_package_share_directory('wamv_description')
wamv_models_path = os.path.join(wamv_path, 'models')

# è®¾ç½®Gazeboèµ„æºæœç´¢è·¯å¾„
set_resource_path = SetEnvironmentVariable(
    name='GZ_SIM_RESOURCE_PATH',
    value=f"{wamv_models_path}:{existing_path}"
)
```

## 3. èŠ‚ç‚¹ä¸æ¥å£æ¸…å• (Node & Interface Audit)

### å·²å®ç°çš„è‡ªå®šä¹‰èŠ‚ç‚¹

| èŠ‚ç‚¹åç§° | åŒ…å | æ ¸å¿ƒåŠŸèƒ½ |
|---------|------|----------|
| `robot_state_publisher` | robot_state_publisher | å‘å¸ƒæœºå™¨äººçŠ¶æ€å’ŒTFå˜æ¢ |
| `ros_gz_sim create` | ros_gz_sim | åœ¨Gazeboä¸­åˆ›å»ºæœºå™¨äººå®ä½“ |
| `parameter_bridge` | ros_gz_bridge | ä¼ æ„Ÿå™¨æ•°æ®æ¡¥æ¥ |
| `obstacle_spawner` | usv_sim_full | éšœç¢ç‰©ç”Ÿæˆå™¨ |

### æ ¸å¿ƒè¯é¢˜æ¥å£

**å‘å¸ƒçš„è¯é¢˜ (Published Topics)**ï¼š
```
/sensors/lidar/front/points     [sensor_msgs/PointCloud2]    # æ¿€å…‰é›·è¾¾ç‚¹äº‘
/sensors/camera/front/image_raw [sensor_msgs/Image]          # æ‘„åƒå¤´å›¾åƒ
/sensors/imu/data               [sensor_msgs/Imu]            # IMUæ•°æ®
/sensors/gps/data               [sensor_msgs/NavSatFix]      # GPSå®šä½
/model/wamv/odometry            [nav_msgs/Odometry]          # é‡Œç¨‹è®¡
/model/wamv/joint_state         [sensor_msgs/JointState]     # å…³èŠ‚çŠ¶æ€
/model/wamv/pose                [tf2_msgs/TFMessage]         # TFå˜æ¢
/clock                          [rosgraph_msgs/Clock]        # ä»¿çœŸæ—¶é’Ÿ
```

**è®¢é˜…çš„è¯é¢˜ (Subscribed Topics)**ï¼š
```
/wamv/thrusters/left/thrust     [std_msgs/Float64]           # å·¦æ¨è¿›å™¨æ¨åŠ›
/wamv/thrusters/right/thrust    [std_msgs/Float64]           # å³æ¨è¿›å™¨æ¨åŠ›
/wamv/thrusters/left/pos        [std_msgs/Float64]           # å·¦æ¨è¿›å™¨è§’åº¦
/wamv/thrusters/right/pos       [std_msgs/Float64]           # å³æ¨è¿›å™¨è§’åº¦
```

### ros_gz_bridge é…ç½®

**é…ç½®æ–¹å¼**ï¼šYAMLæ–‡ä»¶é©±åŠ¨ï¼ˆéç¡¬ç¼–ç ï¼‰

```yaml
# config/global_bridge.yaml (å…¨å±€æ¡¥æ¥)
- ros_topic_name: "/clock"
  gz_topic_name: "/clock" 
  ros_type_name: "rosgraph_msgs/msg/Clock"
  gz_type_name: "gz.msgs.Clock"
  direction: BIDIRECTIONAL

# åŠ¨æ€ç”Ÿæˆçš„ä¼ æ„Ÿå™¨æ¡¥æ¥é…ç½®
- ros_topic_name: "/sensors/lidar/front/points"
  gz_topic_name: "/world/sydney_regatta/model/wamv/sensor/lidar/front/points"
  ros_type_name: "sensor_msgs/msg/PointCloud2"
  gz_type_name: "gz.msgs.PointCloudPacked"
  direction: GZ_TO_ROS
```

## 4. ä¾èµ–ä¸é…ç½® (Dependencies & Config)

### æ ¸å¿ƒä¾èµ–åŒ… (package.xml)

```xml
<!-- ROS 2æ ¸å¿ƒä¾èµ– -->
<depend>rclpy</depend>
<depend>std_msgs</depend>
<depend>sensor_msgs</depend>
<depend>geometry_msgs</depend>
<depend>nav_msgs</depend>
<depend>tf2_ros</depend>

<!-- ä»¿çœŸç›¸å…³ -->
<depend>xacro</depend>
<depend>robot_state_publisher</depend>
<depend>ros_gz_sim</depend>
<depend>ros_gz_bridge</depend>

<!-- VRXæ¡†æ¶ -->
<depend>vrx_gz</depend>
<depend>wamv_gazebo</depend>
<depend>wamv_description</depend>
```

### YAMLé…ç½®ç»“æ„ç¤ºä¾‹

**ç‰©ç†å‚æ•°é…ç½®**ï¼š
```yaml
robot:
  overrides:
    mass: 180.0                    # è´¨é‡(kg)
    inertia: [100.0, 100.0, 200.0] # æƒ¯æ€§çŸ©é˜µ[kgÂ·mÂ²]
    visual_mesh: "package://wamv_description/models/WAM-V-Base/mesh/WAM-V-Base.dae"
    
  buoyancy_params:
    hull_length: 4.9             # èˆ¹ä½“é•¿åº¦(m)
    hull_radius: 0.213           # èˆ¹ä½“åŠå¾„(m)
    xU: 100.0                    # çº¿æ€§é˜»åŠ›ç³»æ•°
    xUU: 150.0                   # äºŒæ¬¡é˜»åŠ›ç³»æ•°
```

**éšœç¢ç‰©å®šä¹‰**ï¼š
```yaml
obstacles:
  random_areas:
    - name: "zone_a"
      type: "cylinder"
      count: 5
      center: [15.0, 5.0]
      radius: 100.0
      size_range: [0.3, 0.8]
      color: "Red"
      
  fixed_list:
    - name: "buoy_start"
      type: "cylinder"
      pose: [5.0, 100.0, 0.0]
      size: [0.5, 1.0]
      color: "Green"
```

## 5. å¾…è§£å†³äº‹é¡¹ (TODOs & Known Issues)

### ä»£ç æ³¨é‡Šä¸­çš„å¾…åŠäº‹é¡¹

1. **æœºå™¨äººå¯åŠ¨æ–‡ä»¶ä¸­çš„é¢„ç•™ä½ç½®** (`robot_bringup.launch.py:157`)
   ```python
   # TODO: åœ¨æ­¤å¤„æ’å…¥è·¯å¾„è§„åˆ’ (Nav2) å’Œå®šä½ (EKF) èŠ‚ç‚¹
   # ç¤ºä¾‹é¢„ç•™ä½ç½®:
   # nav2_nodes = IncludeLaunchDescription(...)  # Nav2å¯¼èˆªæ ˆ
   # ekf_localization_node = Node(...)         # EKFå®šä½èŠ‚ç‚¹
   ```

### å·²è¯†åˆ«çš„æŠ€æœ¯é—®é¢˜

1. **ç¡¬ç¼–ç è·¯å¾„é—®é¢˜**ï¼š
   - `session_manager.py` ä¸­å­˜åœ¨å¤‡ç”¨è·¯å¾„ç¡¬ç¼–ç 
   - `infra_sim.launch.py` ä¸­æœ‰é»˜è®¤è·¯å¾„å›é€€æœºåˆ¶

2. **ç¯å¢ƒå˜é‡ä¾èµ–**ï¼š
   - éœ€è¦æ­£ç¡®è®¾ç½® `GZ_SIM_RESOURCE_PATH` æ‰èƒ½åŠ è½½æ¨¡å‹
   - ä¾èµ– `GAZEBO_MODEL_PATH` å‘åå…¼å®¹

3. **åè®®å…¼å®¹æ€§**ï¼š
   - URDFä¸­ä½¿ç”¨ `package://` åè®®éœ€è¦åå¤„ç†è½¬æ¢ä¸º `model://`
   - å­˜åœ¨æ½œåœ¨çš„è·¯å¾„æ˜ å°„ä¸ä¸€è‡´é£é™©

### å»ºè®®æ”¹è¿›æ–¹å‘

1. **é…ç½®çµæ´»æ€§**ï¼š
   - å¢åŠ æ›´å¤šçš„ä¼ æ„Ÿå™¨ç±»å‹æ”¯æŒ
   - æä¾›æ›´ä¸°å¯Œçš„ç‰©ç†å‚æ•°é…ç½®é€‰é¡¹

2. **ç³»ç»Ÿå¥å£®æ€§**ï¼š
   - å®Œå–„é”™è¯¯å¤„ç†å’Œå›é€€æœºåˆ¶
   - å¢åŠ é…ç½®æ–‡ä»¶éªŒè¯åŠŸèƒ½

3. **æ‰©å±•åŠŸèƒ½**ï¼š
   - å®ç°Nav2å¯¼èˆªæ ˆé›†æˆ
   - æ·»åŠ EKFå®šä½æ»¤æ³¢å™¨
   - æ”¯æŒå¤šæœºå™¨äººä»¿çœŸåœºæ™¯