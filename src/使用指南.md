# USV仿真系统使用指南

## 目录
1. [简介](#简介)
2. [系统要求](#系统要求)
3. [环境依赖](#环境依赖)
4. [环境搭建](#环境搭建)
5. [编译VRX功能包](#编译vrz功能包)
6. [运行仿真](#运行仿真)
7. [配置说明](#配置说明)
8. [故障排除](#故障排除)

## 简介

本项目是一个基于ROS 2 + Gazebo Garden + VRX的无人船（USV）仿真环境启动系统，支持通过YAML配置驱动的灵活仿真流程。它为水面无人船（如WAM-V）提供完整的建模、控制、传感器配置与可视化能力。

## 系统要求

- Ubuntu 22.04 LTS
- ROS 2 Humble Hawksbill
- Gazebo Garden (或更高版本)
- Python 3.10+
- CMake 3.8+
- Git

## 环境依赖

### ROS 2 Humble Hawksbill
```bash
# 添加仓库
sudo apt update && sudo apt install -y software-properties-common
sudo add-apt-repository universe
sudo apt update

# 添加ROS仓库密钥
sudo apt install curl gnupg lsb-release
curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key | sudo gpg --dearmor -o /usr/share/keyrings/ros-archive-keyring.gpg

# 添加ROS仓库
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(source /etc/os-release && echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null

# 安装ROS 2 Humble
sudo apt update
sudo apt install ros-humble-desktop
sudo apt install ros-humble-gazebo-ros-pkgs
sudo apt install ros-humble-gazebo-dev
sudo apt install ros-humble-rviz-visual-tools
```

### 设置ROS环境
```bash
# 添加到 ~/.bashrc
echo "source /opt/ros/humble/setup.bash" >> ~/.bashrc
source ~/.bashrc
```

### 其他依赖
```bash
sudo apt install python3-colcon-common-extensions
sudo apt install python3-rosdep
sudo apt install ruby-dev  # 用于Gazebo Ruby脚本
```

## 环境搭建

### 1. 创建工作空间
```
解压simulation压缩包
```

### 2. 安装依赖

```bash
cd ~/simulation/vrx_ws

# 安装ROS依赖
rosdep install --from-paths src --ignore-src -r -y
```

## 编译功能包

### 1. 编译

```bash
cd ~/simulation/vrx_ws

# 编译相关包
colcon build --packages-select \
  vrx_gazebo \
  vrx_ros \
  vrx_gz \
  wamv_description \
  wamv_gazebo \
  usv_sim_full \
  --cmake-args -DCMAKE_BUILD_TYPE=Release
```



### 2. 源环境变量

```bash
source ~/simulation/vrx_ws/install/setup.bash
```


## 运行仿真

### 1. 基础仿真启动

```bash
cd ~/simulation/vrx_ws
source install/setup.bash

# 启动基础仿真环境
ros2 launch usv_sim_full main.launch.py config_path:='./src/usv_sim_full/config/full_config.yaml'
```


```bash
#调整某个文件后的快速编译执行
colcon build --packages-select \
  vrx_gazebo \
  vrx_ros \
  vrx_gz \
  wamv_description \
  wamv_gazebo \
  usv_sim_full \
  --cmake-args -DCMAKE_BUILD_TYPE=Release
source ~/simulation/vrx_ws/install/setup.bash
ros2 launch usv_sim_full main.launch.py config_path:='./src/usv_sim_full/config/full_config.yaml'
```
### 2. 仿真组件说明

- **Gazebo仿真环境**: 加载指定的世界场景（如sydney_regatta）
- **WAM-V机器人**: 带有传感器和推进器的无人船模型
- **传感器桥接**: 连接Gazebo与ROS 2的传感器数据
- **RViz可视化**: 显示机器人状态和传感器数据

### 3. 键盘控制

启动另一个终端进行键盘控制：

```bash
cd ~/simulation/vrx_ws
source install/setup.bash
python3 src/usv_sim_full/scripts/dual_thruster_teleop_incre.py
```

使用键盘方向键控制船只前进、后退、转向。

## 配置说明

### 1. 主配置文件

位于 `~/simulation/vrx_ws/src/usv_sim_full/config/full_config.yaml`

#### 机器人配置 (`robot`)
```yaml
robot:
  name: "usv"                        # 机器人名称
  xacro_template: "wamv_gazebo.urdf.xacro"  # Xacro模板
  package_name: "wamv_gazebo"        # 包名
  xacro_relative_path: "urdf/wamv_gazebo.urdf.xacro"  # 相对路径
  thruster_config: "H"               # 推进器配置
  overrides:                         # 物理参数覆盖
    mass: 50.0
    ixx: 10.0
    iyy: 10.0
    izz: 10.0
  buoyancy_params:                   # 浮力参数
    hull_length: 1.5
    hull_radius: 0.3
    fluid_level_offset: 0.0
    heave_damping_coef: 50.0
    linear_damping_coef: 50.0
    angular_damping_coef: 50.0
```

#### 环境配置 (`environment`)
```yaml
environment:
  world_name: "sydney_regatta"       # 世界名称
  gz_args: "-r -v 4"                 # Gazebo启动参数
```

#### 传感器配置 (`sensors`)
```yaml
sensors:
  lidars:                            # 激光雷达配置
    - name: "front"
      enabled: true
      parent_link: "base_link"
      xyz: [0.5, 0.0, 0.5]
      rpy: [0.0, 0.0, 0.0]
      topic: "/sensors/lidar/front/points"
  
  cameras:                           # 摄像头配置
    - name: "front"
      enabled: true
      parent_link: "base_link"
      xyz: [0.5, 0.0, 0.5]
      rpy: [0.0, 0.0, 0.0]
      topic: "/sensors/camera/front/image_raw"
      info_topic: "/sensors/camera/front/camera_info"
  
  imus:                              # IMU配置
    - name: "imu_sensor"
      enabled: true
      parent_link: "base_link"
      xyz: [0.0, 0.0, 0.5]
      rpy: [0.0, 0.0, 0.0]
      topic: "/sensors/imu/data"
      update_rate: 100
  
  gps_sensors:                       # GPS配置
    - name: "gps_sensor"
      enabled: true
      parent_link: "base_link"
      xyz: [0.0, 0.0, 0.5]
      rpy: [0.0, 0.0, 0.0]
      topic: "/sensors/gps/data"
      update_rate: 20
```

#### 可视化配置 (`visualization`)
```yaml
visualization:
  launch_rviz: true                  # 是否启动RViz
  enable_telemetry: true             # 是否启用遥测数据
```

### 2. 自定义配置

你可以创建自己的配置文件，只需遵循上述结构即可。例如：

```yaml
robot:
  name: "my_usv"
  xacro_template: "wamv_gazebo.urdf.xacro"
  # ... 其他配置

environment:
  world_name: "simple_demo"
  gz_args: "-r -v 4"
  
sensors:
  lidars:
    - name: "lidar_1"
      enabled: true
      parent_link: "base_link"
      xyz: [0.5, 0.0, 0.5]
      rpy: [0.0, 0.0, 0.0]
  # ... 其他传感器配置
```

## 故障排除

### 1. 编译错误

**错误**: `Could not find a package configuration file provided by "gz-sim7"`

**解决方案**: 安装Gazebo Garden
```bash
# 添加Gazebo仓库
curl -fsSL https://gazebosim.jfrog.io/gazebosim/gazebo_signing.key | sudo gpg --dearmor -o /usr/share/keyrings/gazebo-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/gazebo-archive-keyring.gpg] https://gazebosim.jfrog.io/gazebosim/debian-stable $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/gazebo.list > /dev/null

sudo apt update
sudo apt install gz-harmonic
```

### 2. 启动失败

**错误**: `launch configuration 'config_path' does not exist`

**解决方案**: 确保提供了正确的配置文件路径
```bash
ros2 launch usv_sim_full main.launch.py config_path:='/path/to/your/config.yaml'
```

### 3. 传感器数据问题

**问题**: 传感器话题没有数据

**检查步骤**:
```bash
# 查看所有话题
ros2 topic list

# 检查特定话题是否有数据
ros2 topic echo /sensors/imu/data

# 检查桥接是否正常
ros2 run ros_gz_bridge parameter_bridge --ros-args --params-file /path/to/bridge_config.yaml
```

### 4. 模型加载问题

**错误**: Gazebo中找不到模型

**解决方案**:
```bash
# 检查模型路径
echo $GAZEBO_MODEL_PATH

# 临时添加模型路径
export GAZEBO_MODEL_PATH=$GAZEBO_MODEL_PATH:/path/to/vrx/models
```

### 5. 性能问题

如果仿真运行缓慢：

- 关闭不必要的传感器
- 减少Gazebo渲染质量（通过GUI设置）
- 调整物理更新率
- 使用headless模式运行（无图形界面）

## 常用命令

```bash
# 查看所有可用话题
ros2 topic list

# 查看特定话题信息
ros2 topic info /sensors/imu/data

# 查看所有节点
ros2 node list

# 查看TF树
ros2 run tf2_tools view_frames

# 查看参数
ros2 param list

# 保存当前配置
ros2 param dump <node_name> --output params.yaml
```

## 自定义开发

### 添加新传感器

1. 修改`templates/sensor_macros.xacro`添加传感器宏定义
2. 更新`session_manager.py`中的传感器处理逻辑
3. 在配置文件中添加新传感器的配置
4. 重新构建项目

### 添加新世界

1. 将`.sdf`世界文件放在`test_env`目录
2. 更新`config/full_config.yaml`中的`world_name`
3. 重新启动仿真

---

如遇其他问题，请参考[VRX官方文档](https://github.com/osrf/vrx)或提交Issue。